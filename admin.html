<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - SmartPark (Hardened)</title>

  <!-- SECURITY: Content Security Policy (CSP) -->
  <!-- Note: For maximum security move scripts/styles to external files and use nonces/SRI and server-set CSP headers. -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https:; script-src 'self' https://unpkg.com 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data:; object-src 'none'; frame-ancestors 'none'; base-uri 'self';">

  <!-- Other recommended security policies (prefer to be set by server headers) -->
  <meta name="referrer" content="no-referrer-when-downgrade">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta name="robots" content="noindex,nofollow">
  <meta name="permissions-policy" content="camera=(), microphone=(), geolocation=()">

  <!-- Use a trusted CDN for icons (consider bundling to reduce third-party dependency) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">

  <!-- QR library (consider bundling into your build for production) -->
  <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js" defer></script>

  <style>
    :root { --bg-gradient: linear-gradient(170deg,#FF9933,#FFFFFF,#138808); --primary-accent:#FF9933; --secondary-accent:#138808; --danger-accent:#d93025; --header-bg:#000080; --text-color:#333; --card-bg:rgba(255,255,255,.9); --header-text-color:#fff; }
    body {font-family:'Segoe UI',sans-serif; background:var(--bg-gradient); background-attachment:fixed; color:var(--text-color); margin:0}
    .header{background:var(--header-bg);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--primary-accent);box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .logo{font-family:Montserrat,sans-serif;font-weight:700;color:var(--header-text-color)}
    .container{max-width:1400px;margin:2rem auto;padding:2rem;background:var(--card-bg);backdrop-filter:blur(10px);border-radius:15px}
    /* ... trimmed for brevity; keep your styles as is ... */
    .scan-section{display:flex;gap:1rem;align-items:center;background:#f8f9fa;padding:20px;border-radius:8px}
    table{width:100%;border-collapse:collapse}
  </style>
</head>
<body>

<script>
// Enforce HTTPS in browsers (HSTS must be set server-side for full protection)
if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
  location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
}
</script>

<header class="header">
  <div class="logo">SmartPark Admin</div>
  <button id="logout-btn" class="btn" aria-label="Logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
</header>

<div class="container" id="app">
  <div class="live-panel-container">
    <h2><i class="fas fa-satellite-dish"></i> Live Session Management</h2>
    <div class="scan-section">
      <input type="text" id="qr-scan-input" placeholder="Enter Booking ID or use camera..." aria-label="Booking ID input">
      <button id="scan-btn" class="btn"><i class="fas fa-camera"></i> Scan</button>
      <button id="process-arrival-btn" class="btn"><i class="fas fa-check-circle"></i> Confirm</button>
    </div>
    <div id="qr-reader" style="width:100%;max-width:500px;margin:10px auto;display:none"></div>
    <div id="all-bookings-list">
      <h3><i class="fas fa-list-ul"></i> Active Bookings</h3>
      <div id="admin-bookings-container" aria-live="polite"></div>
    </div>
  </div>

  <h1><i class="fas fa-book"></i> All Bookings History</h1>
  <div class="controls">
    <button id="export-btn" class="btn"><i class="fas fa-file-excel"></i> Export to CSV</button>
    <button id="clear-btn" class="btn"><i class="fas fa-trash-alt"></i> Clear Local UI Cache</button>
  </div>
  <div class="table-container">
    <table id="bookings-table" aria-describedby="bookings-description">
      <thead>
        <tr><th>Status</th><th>Booking Month</th><th>Booking Date & Time</th><th>Spot ID(s)</th><th>Customer Name</th><th>Mobile Number</th><th>Vehicle Number</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ====== SECURITY-CENTRIC JAVASCRIPT ======
   Design principles applied:
   - No secrets (API keys) embedded in frontend
   - Session validated via server endpoints
   - Use credentials 'include' to send HttpOnly cookies
   - Do not persist sensitive booking data to localStorage
   - Sanitize all strings before inserting into DOM
   - Avoid innerHTML where possible; use textContent/innerText
   - Graceful error handling and limited data exposure
*/

// Helpers
function sanitizeString(str) {
  if (typeof str !== 'string') return '';
  // Simple DOM-based escaping
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function safeText(node, value) {
  node.textContent = value == null ? '' : value;
}

// App state (in-memory only)
let bookingsCache = []; // never persisted to localStorage or cookies

// DOM refs
const bookingsTableBody = document.querySelector('#bookings-table tbody');
const exportBtn = document.getElementById('export-btn');
const clearBtn = document.getElementById('clear-btn');
const qrScanInput = document.getElementById('qr-scan-input');
const processArrivalBtn = document.getElementById('process-arrival-btn');
const adminBookingsContainer = document.getElementById('admin-bookings-container');
const scanBtn = document.getElementById('scan-btn');
const qrReaderDiv = document.getElementById('qr-reader');
const logoutBtn = document.getElementById('logout-btn');

// Session validation: call server to confirm admin status
async function validateSession() {
  try {
    const resp = await fetch('/api/auth/validate', { method: 'GET', credentials: 'include', cache: 'no-store' });
    if (!resp.ok) throw new Error('Not authenticated');
    const data = await resp.json();
    // Server should return { authenticated: true, role: 'admin' }
    if (!data || !data.authenticated || data.role !== 'admin') {
      alert('Access denied - please login as admin.');
      window.location.href = '/login';
      return false;
    }
    return true;
  } catch (err) {
    console.warn('Session validation failed:', err);
    alert('Session invalid or expired. Redirecting to login.');
    window.location.href = '/login';
    return false;
  }
}

// Load bookings securely from backend (no API keys in client)
async function loadBookingData() {
  try {
    // Use a server API that enforces authorization and returns only permitted fields
    const resp = await fetch('/api/bookings?limit=500', { method: 'GET', credentials: 'include', cache: 'no-store' });
    if (!resp.ok) throw new Error('Failed to fetch bookings');
    const bookings = await resp.json();

    // Keep an in-memory cache only
    bookingsCache = Array.isArray(bookings) ? bookings : [];

    renderBookingsTable(bookingsCache);
    renderAdminBookingsList(bookingsCache);
    exportBtn.disabled = bookingsCache.length === 0;
    clearBtn.disabled = bookingsCache.length === 0;

  } catch (err) {
    console.error('Error loading booking data:', err);
    bookingsTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center">Error loading data from server.</td></tr>`;
    exportBtn.disabled = true;
    clearBtn.disabled = true;
  }
}

function renderBookingsTable(bookings) {
  bookingsTableBody.innerHTML = '';
  if (!bookings || bookings.length === 0) {
    bookingsTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center">No booking data found.</td></tr>`;
    return;
  }

  // Sort and display
  bookings.slice().sort((a,b) => (b.entryTime||0) - (a.entryTime||0)).forEach(b => {
    const tr = document.createElement('tr');

    const status = document.createElement('td'); safeText(status, b.status || 'Unknown'); tr.appendChild(status);
    const month = document.createElement('td'); safeText(month, b.entryTime ? (new Date(b.entryTime)).toLocaleString('default',{month:'long', year:'numeric'}) : ''); tr.appendChild(month);
    const dt = document.createElement('td'); safeText(dt, b.entryTime ? new Date(b.entryTime).toLocaleString() : ''); tr.appendChild(dt);
    const spots = document.createElement('td'); safeText(spots, Array.isArray(b.spots) ? b.spots.join(', ') : (b.spots || b.bookedSpots || '')); tr.appendChild(spots);
    const name = document.createElement('td'); safeText(name, b.fullname || b.customerName || ''); tr.appendChild(name);
    const mobile = document.createElement('td'); safeText(mobile, b.mobile || ''); tr.appendChild(mobile);
    const vehicle = document.createElement('td'); safeText(vehicle, b.primaryVehicle || ''); tr.appendChild(vehicle);

    bookingsTableBody.appendChild(tr);
  });
}

function renderAdminBookingsList(bookings) {
  adminBookingsContainer.innerHTML = '';
  bookings.filter(b => b.status !== 'completed').slice(0,50).forEach(b => {
    const div = document.createElement('div'); div.className = 'admin-booking-item';
    const heading = document.createElement('div'); heading.style.fontWeight = '700'; heading.textContent = `${b.bookingId || ''} â€” ${b.fullname || b.customerName || ''}`;
    const status = document.createElement('div'); status.className = 'status-badge ' + (b.status === 'arrived' ? 'status-arrived' : (b.status === 'booked' ? 'status-booked' : 'status-unknown'));
    status.textContent = b.status || 'unknown';
    div.appendChild(heading); div.appendChild(status);
    adminBookingsContainer.appendChild(div);
  });
}

// Process arrival confirmation with server-side update
async function processArrivalConfirmation(qrInput) {
  try {
    const raw = (qrInput || '').trim();
    let bookingId = '';
    // Avoid trusting parsed client JSON; only accept simple bookingId strings or server-specified format
    if (raw.startsWith('{')) {
      try { const parsed = JSON.parse(raw); bookingId = parsed.bookingId || parsed.id || ''; } catch(e) { bookingId = '' }
    } else bookingId = raw;

    if (!bookingId) { alert('Invalid Booking ID'); return false; }

    // Send booking arrival confirmation to server; server must authenticate and validate permissions
    const resp = await fetch('/api/bookings/' + encodeURIComponent(bookingId) + '/arrive', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ timestamp: Date.now() }) });
    if (!resp.ok) {
      const errText = await resp.text();
      alert('Failed to confirm arrival: ' + (errText || resp.statusText));
      return false;
    }

    // Refresh view from server
    await loadBookingData();
    alert('Arrival confirmed for booking ' + bookingId);
    return true;
  } catch (err) {
    console.error('Processing Error:', err);
    alert('Invalid QR code or Booking ID format.');
    return false;
  }
}

// Client CSV export: exports in-memory cache only; does NOT store PII in localStorage
function exportToCSV() {
  if (!Array.isArray(bookingsCache) || bookingsCache.length === 0) { alert('No data to export.'); return; }
  let csv = 'Status,Booking Month,Booking Date & Time,Spot IDs,Customer Name,Mobile,Vehicle Number\n';
  bookingsCache.forEach(b => {
    const entryDate = b.entryTime ? new Date(b.entryTime) : '';
    const month = entryDate ? (entryDate.toLocaleString('default',{month:'long'}) + ' ' + entryDate.getFullYear()) : '';
    const row = [b.status||'Unknown', month, entryDate?entryDate.toLocaleString():'', (b.spots||b.bookedSpots||'').toString(), b.fullname||b.customerName||'', b.mobile||'', b.primaryVehicle||''].map(v=> '"' + String(v).replace(/"/g,'""') + '"').join(',');
    csv += row + '\r\n';
  });
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.setAttribute('download', `SmartPark_Bookings_${Date.now()}.csv`); a.click();
  URL.revokeObjectURL(url);
}

// Clear local UI cache only (DO NOT delete server data here)
function clearLocalCache() {
  if (!confirm('This will clear only the local UI cache. Server-side data remains unchanged. Continue?')) return;
  bookingsCache = [];
  renderBookingsTable([]);
  renderAdminBookingsList([]);
}

// Logout via server endpoint (server should clear HttpOnly session cookie)
async function logout() {
  try {
    await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
  } catch(e) { console.warn('Logout request failed', e); }
  // Redirect to login page after logout
  window.location.href = '/login';
}

// QR handling (uses html5-qrcode library; prefer requesting camera permission only when used)
let html5QrcodeScanner = null;
function onScanSuccess(decodedText) {
  qrScanInput.value = decodedText;
  if (html5QrcodeScanner) {
    html5QrcodeScanner.clear().catch(()=>{});
    qrReaderDiv.style.display = 'none';
  }
  processArrivalConfirmation(decodedText);
}
function onScanFailure(error) { /* ignore scan failures quietly */ }

// Wire up event listeners after DOMContentLoaded
document.addEventListener('DOMContentLoaded', async () => {
  // Validate session first
  const ok = await validateSession();
  if (!ok) return;

  // Initial data load
  await loadBookingData();

  // Refresh interval (server-side push via WebSocket or SSE is recommended for production)
  setInterval(() => loadBookingData(), 15000);

  exportBtn.addEventListener('click', exportToCSV);
  clearBtn.addEventListener('click', clearLocalCache);

  processArrivalBtn.addEventListener('click', async () => {
    const val = qrScanInput.value.trim();
    if (!val) { alert('Please enter a booking ID.'); return; }
    if (await processArrivalConfirmation(val)) qrScanInput.value = '';
  });

  scanBtn.addEventListener('click', () => {
    if (!html5QrcodeScanner) html5QrcodeScanner = new Html5QrcodeScanner('qr-reader', { fps: 10, qrbox: { width: 250, height: 250 } }, false);
    qrReaderDiv.style.display = 'block';
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
  });

  logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await logout(); });
});

</script>
</body>
</html>
